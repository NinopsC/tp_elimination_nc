---
title: "TP NGS"
author: "Nina"
date: "12/15/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Count matrix analysis

## Build the coldata (metadata)

```{r}
library(tidyverse)

sampleTable = read_delim("metadata.tsv") %>% as.data.frame()
rownames(sampleTable) = sampleTable$sample_ID
sampleTable
```
## Import data with tximport

```{r}
library(tximport)

dir <- "/home/rstudio/mydatalocal/tp_elimination_nc/results/quantification/"
samples <- list.dirs(dir, full.names = F) 
samples <- samples[samples != ""] # remove "." directory

samples_names <- rownames(sampleTable)

files <- file.path(dir, samples_names, "abundance.h5")
names(files) <- samples_names
files[!file.exists(files)]

txi.kallisto.tmp <- tximport(files[1], type = "kallisto", txOut = TRUE)

transcript_names <- rownames(txi.kallisto.tmp$abundance)
tx2gene <- data.frame(tx=transcript_names,
                  gene=gsub(".t[0-9]*","",transcript_names))
txi.kallisto <- tximport(files, type = "kallisto", tx2gene = tx2gene)
```

```{r}
txi.kallisto
```

## Differential expression analysis

### Build the DESeq2 object

```{r}
library(DESeq2)

dds <- DESeqDataSetFromTximport(txi.kallisto, sampleTable, ~ elimination )
dds <- DESeq(dds)
vsd <- vst(dds, blind=FALSE)
```

### Principal component analysis

```{r}
plotPCA(vsd, intgroup=c("age"))
```
### Further analysis

```{r}
res <- results(dds)
```

```{r}
resultsNames(dds)
```

On compare l'expression génique pendant l'élimination VS avant ou après l'élimination. Donc sur notre plot, les gènes au-dessus de la ligne sont up-régulés pendant l'élimination.

```{r}
plotMA(res, ylim=c(-30,30))
```
Comment identifier ces gènes exprimés différentiellement ?
Avec ce tableau, on a les résultats du plot organisés en tableau (baseMean = abscisse, log2FoldCHange = ordonnée...).

```{r}
res_df <- as.data.frame(res)
head(res_df)
#head : permet de voir les 1eres infos
```

Maintenant, on essaie d'isoler les gènes répartis sur les lignes up/downrégulées.

D'abord, les downrégulés les + extrêmes :

```{r}
subset(res_df, log2FoldChange < -20 & baseMean > 10 & padj < 0.05)
#padj : p-value ajustee (points bleus significatifs)
```

Ensuite, les up-régulés les + extrêmes :

```{r}
subset(res_df, log2FoldChange > 20 & baseMean > 10 & padj < 0.05)
```

Petit résumé de notre expression génique :

```{r}
summary(res)
```

Maintenant, on aimerait bien en savoir plus sur nos gènes différentiellement exprimés.

####Prise en main des outils d'analyse

Fonction plot_counts pour afficher l'expression des genes :

```{r}
plot_counts <- function(X) {
count_df <- counts(dds, normalized=T)
count_dfl = count_df %>% as.data.frame() %>%  rownames_to_column("gene_ID") %>% pivot_longer(-gene_ID,names_to = "sample_ID", values_to = "norm_counts")


df_tmp = subset(count_dfl, gene_ID %in% X) %>% left_join(sampleTable)

df_tmp <- df_tmp %>% mutate(age = factor(age, levels = unique(age)),
                            gene_ID = factor(gene_ID,levels=X))


ggplot(df_tmp, aes(x=age, y = norm_counts, col = age)) + theme_bw() +
  geom_point() +
  facet_wrap(~gene_ID, scales = "free_y" ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
}
```

Fonction pour récupérer les annotations des transcrits depuis Wormbase :

```{r}
#BiocManager::install("biomaRt") # only one time
library(biomaRt)
mart <- useMart("parasite_mart", dataset = "wbps_gene", host = "https://parasite.wormbase.org", port = 443)

genes_annotation <- getBM(mart = mart,
                          filters = c("species_id_1010"),
                          value = list("mebelaprjeb30104"),
                          attributes = c("wbps_gene_id",
                                         "caelegprjna13758_gene_name",
                                         "caelegprjna13758_homolog_ensembl_peptide",
                                         "interpro_id",
                                         "interpro_short_description")
)
#2 premieres colonnes : nom du gene et proteine homologue chez C.elegans
#interpro = base de donnees de domaines proteiques
#3eme et 4eme colonnes : identifiant et description des domaines proteiques
```

Visualiser les résultats (mais pas tout, parce que les gènes annotés sont beaucoup trop nombreux) :

```{r}
genes_annotation[1:15,]
#1:15 indique qu'on veut les 15 premieres lignes,
```
Ok, le code fonctionne bien. 


#### Analyse 1

On cherche les gènes tel que leur expression différentielle soit significative, et qui sont uprégulés pendant l'élimination.

```{r fig.height=14, fig.width=14}
genes_list_1 = subset(res_df, padj < 0.0005 & baseMean > 10 & log2FoldChange > 0)  %>% arrange (padj)
# subset: on applique des filtres dans certaines colonnes pour recuperer seulement certains transcrits, on obtient l'objet gene_list_1
genes_list_1
plot_counts(genes_list_1$gene_ID[1:40])
#on affiche cet objet avec la fonction plot_counts
```

```{r}
de_genes_with_annot_1 <- subset(genes_annotation, wbps_gene_id %in% genes_list_1$gene_ID)
#de = differential expression
#pour savoir a quoi notre subset de gènes correspond, on recupere dans notre grosse table d’annotation les genes qui sont dans notre liste
de_genes_with_annot_1
```

Chercher par mot-clé de domaine protéique dans notre liste :

```{r}
toMatch = c("exonuclease", "transposase", "helicase")
exo_transpo_heli_de_genes = de_genes_with_annot_1[grep(paste(toMatch,collapse="|"), de_genes_with_annot_1$interpro_short_description, ignore.case = T),]

#grep = cherche un pattern dans une chaîne de caractère
#| : je cherche ou exonuclease, ou transposase, ou helicase

exo_transpo_heli_de_genes

plot_counts(unique(exo_transpo_heli_de_genes$wbps_gene_id))
```

#### Analyse 2 : gènes downrégulés (faite par Quentin en live)

#### Analyse 3 : comparaison 2 stades consécutifs

#####Build the DESeq2 object
```{r}
dds2 <- DESeqDataSetFromTximport(txi.kallisto, sampleTable, ~ de_analysis )
dds2 <- DESeq(dds2)
vsd2 <- vst(dds2, blind=FALSE)
```

```{r}
res2 <- results(dds2)
```

```{r}
resultsNames(dds2)
```

```{r}
plotMA(res2, ylim=c(-30,30))
```

